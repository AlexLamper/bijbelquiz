
import { getServerSession } from "next-auth";
import { authOptions } from "@/lib/auth";
import { redirect } from "next/navigation";
import { connectDB, UserProgress } from "@bijbelquiz/database";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Lock, Trophy, Zap, Calendar, Star, TrendingUp, BookOpen } from "lucide-react";
import Link from 'next/link';

// We need to define the type for accurate calculating
interface ProgressDoc {
    score: number;
    totalQuestions: number;
    completedAt: Date;
    quizId: { title: string; _id: string } | null;
}

export const metadata = {
    title: 'Mijn Dashboard | BijbelQuiz',
    description: 'Bekijk uw studievoortgang en statistieken.',
};

export default async function DashboardPage() {
  const session = await getServerSession(authOptions);

  if (!session?.user) {
    redirect("/api/auth/signin?callbackUrl=/dashboard");
  }

  await connectDB();
  const userId = session.user.id;
  const isPremium = session.user.isPremium;

  // Fetch user progress
  const progressDocs = await UserProgress.find({ userId }).sort({ completedAt: -1 }).populate('quizId').lean() as unknown as ProgressDoc[];

  // Calculate Basic Stats
  const totalQuizzes = progressDocs.length;
  const totalScore = progressDocs.reduce((acc, curr) => acc + curr.score, 0);
  const totalPossible = progressDocs.reduce((acc, curr) => acc + curr.totalQuestions, 0);
  const averageAccuracy = totalPossible > 0 ? Math.round((totalScore / totalPossible) * 100) : 0;
  
  // Calculate Premium Stats (Streak, etc) - Mock logic for now or real if data allows
  // For streak: check consecutive days (simplified)
  let streak = 0;
  if(isPremium && progressDocs.length > 0) {
      // Logic for streak calculation would go here
      streak = 3; // Placeholder for visual
  }

  return (
    <div className="container px-4 py-8 md:py-12 mx-auto max-w-6xl">
      {/* Header Section */}
      <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
        <div>
          <h1 className="text-3xl font-serif font-bold text-slate-900">
            Welkom terug, {session.user.name?.split(' ')[0] || 'Bijbelstudent'}
          </h1>
          <p className="text-slate-600 mt-1">
            {isPremium 
              ? "U bent een Premium lid. Uw studie vordert gestaag." 
              : "Upgrade naar Premium om uw volledige studievoortgang te ontsluiten."}
          </p>
        </div>
        {!isPremium && (
           <Button asChild className="bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-600 hover:to-amber-700 text-white shadow-lg border-0">
             <Link href="/premium">
                <Star className="mr-2 h-4 w-4 fill-white" /> Word Premium
             </Link>
           </Button>
        )}
      </div>

      {/* Main Grid */}
      <div className="grid grid-cols-1 md:grid-cols-12 gap-6">
        
        {/* Left Column: Stats */}
        <div className="md:col-span-8 space-y-6">
            
            {/* Quick Stats Row */}
            <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                <Card className="bg-white border-slate-200">
                    <CardHeader className="pb-2">
                        <CardTitle className="text-sm font-medium text-slate-500 uppercase tracking-wider">Voltooide Quizzen</CardTitle>
                    </CardHeader>
                    <CardContent>
                        <div className="text-3xl font-bold text-slate-800">{totalQuizzes}</div>
                    </CardContent>
                </Card>
                
                <Card className="bg-white border-slate-200">
                    <CardHeader className="pb-2">
                        <CardTitle className="text-sm font-medium text-slate-500 uppercase tracking-wider">Gemiddelde Score</CardTitle>
                    </CardHeader>
                    <CardContent>
                        <div className={`text-3xl font-bold ${averageAccuracy >= 80 ? 'text-emerald-600' : 'text-slate-800'}`}>
                            {averageAccuracy}%
                        </div>
                    </CardContent>
                </Card>

                {/* Premium Stat: Streak */}
                <Card className={`relative bg-white border-slate-200 ${!isPremium ? 'opacity-70' : ''}`}>
                    <CardHeader className="pb-2">
                         <div className="flex justify-between items-center">
                            <CardTitle className="text-sm font-medium text-slate-500 uppercase tracking-wider">Dagen Reeks</CardTitle>
                            {!isPremium && <Lock className="h-4 w-4 text-slate-400" />}
                        </div>
                    </CardHeader>
                    <CardContent>
                         {isPremium ? (
                             <div className="flex items-baseline gap-1">
                                <div className="text-3xl font-bold text-amber-600">{streak}</div>
                                <span className="text-sm text-slate-500">dagen</span>
                             </div>
                         ) : (
                             <div className="blur-sm select-none text-3xl font-bold text-slate-300">
                                42
                             </div>
                         )}
                    </CardContent>
                </Card>
            </div>

            {/* Recent Activity */}
            <Card className="border-slate-200">
                <CardHeader>
                    <CardTitle className="font-serif">Recente Activiteit</CardTitle>
                </CardHeader>
                <CardContent>
                    {progressDocs.length === 0 ? (
                        <div className="text-center py-8 bg-slate-50 rounded-lg">
                            <p className="text-slate-500 mb-4">U heeft nog geen quizzen gemaakt.</p>
                            <Button asChild variant="outline">
                                <Link href="/">Start uw eerste quiz</Link>
                            </Button>
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {progressDocs.slice(0, 5).map((progress, i) => (
                                <div key={i} className="flex items-center justify-between p-3 hover:bg-slate-50 rounded-lg transition-colors border border-transparent hover:border-slate-100">
                                    <div className="flex items-center gap-4">
                                        <div className={`
                                            w-10 h-10 rounded-full flex items-center justify-center font-bold text-sm
                                            ${progress.score === progress.totalQuestions ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-600'}
                                        `}>
                                            {Math.round((progress.score / progress.totalQuestions) * 100)}%
                                        </div>
                                        <div>
                                            <p className="font-medium text-slate-800">
                                                {progress.quizId?.title || "Onbekende Quiz"}
                                            </p>
                                            <p className="text-xs text-slate-500">
                                                {new Date(progress.completedAt).toLocaleDateString('nl-NL', { day: 'numeric', month: 'long' })}
                                            </p>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                       <span className="text-sm font-medium text-slate-600">
                                           {progress.score}/{progress.totalQuestions}
                                       </span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </CardContent>
            </Card>

             {/* Detailed Analytics (Locked for free users) */}
             <Card className={`border-slate-200 overflow-hidden ${!isPremium ? 'border-dashed' : ''}`}>
                <CardHeader className={`${!isPremium ? 'bg-slate-50/50' : ''}`}>
                    <div className="flex justify-between items-center">
                        <div className="space-y-1">
                             <CardTitle className="font-serif flex items-center gap-2">
                                <TrendingUp className="h-5 w-5 text-primary" />
                                Kennisanalyse
                             </CardTitle>
                             <CardDescription>Uw sterke en zwakke punten per categorie.</CardDescription>
                        </div>
                        {!isPremium && <Badge variant="secondary" className="bg-amber-100 text-amber-800 border-amber-200">Premium</Badge>}
                    </div>
                </CardHeader>
                <CardContent className="relative">
                    {!isPremium && (
                        <div className="absolute inset-0 bg-white/60 backdrop-blur-[2px] z-10 flex flex-col items-center justify-center p-6 text-center">
                            <Lock className="h-8 w-8 text-slate-400 mb-3" />
                            <h3 className="font-bold text-slate-800 mb-1">Ontgrendel uw statistieken</h3>
                            <p className="text-slate-500 text-sm mb-4 max-w-xs">
                                Zie precies welke onderwerpen u beheerst en waar u nog kunt groeien.
                            </p>
                            <Button size="sm" asChild className="bg-amber-600 hover:bg-amber-700 text-white">
                                <Link href="/premium">Bekijk Premium</Link>
                            </Button>
                        </div>
                    )}

                    <div className="space-y-4 pt-2">
                        {/* Mock data for visualisation */}
                        <div className="space-y-2">
                            <div className="flex justify-between text-sm">
                                <span className="font-medium flex items-center gap-2"><BookOpen className="h-3 w-3" /> Oude Testament</span>
                                <span className="text-emerald-600 font-bold">85%</span>
                            </div>
                            <div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden">
                                <div className="h-full bg-emerald-500" style={{ width: '85%' }}></div>
                            </div>
                        </div>

                        <div className="space-y-2">
                             <div className="flex justify-between text-sm">
                                <span className="font-medium flex items-center gap-2"><BookOpen className="h-3 w-3" /> Nieuwe Testament</span>
                                <span className="text-blue-600 font-bold">62%</span>
                            </div>
                            <div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden">
                                <div className="h-full bg-blue-500" style={{ width: '62%' }}></div>
                            </div>
                        </div>

                        <div className="space-y-2">
                             <div className="flex justify-between text-sm">
                                <span className="font-medium flex items-center gap-2"><Zap className="h-3 w-3" /> Profetie</span>
                                <span className="text-amber-600 font-bold">45%</span>
                            </div>
                             <div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden">
                                <div className="h-full bg-amber-500" style={{ width: '45%' }}></div>
                            </div>
                        </div>
                    </div>
                </CardContent>
            </Card>

        </div>

        {/* Right Column: Gamification/Profile */}
        <div className="md:col-span-4 space-y-6">
            
            {/* Level Card */}
             <Card className="bg-gradient-to-br from-primary/90 to-primary/80 text-white border-0 shadow-xl overflow-hidden relative">
                <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -translate-y-16 translate-x-16 blur-2xl"></div>
                
                <CardHeader>
                    <CardTitle className="text-white/90 uppercase text-xs tracking-widest font-semibold flex items-center gap-2">
                        <Trophy className="h-4 w-4 text-amber-300" /> Uw Niveau
                    </CardTitle>
                </CardHeader>
                <CardContent className="text-center pb-8 pt-2">
                     <div className="mb-4 inline-flex items-center justify-center p-4 bg-white/20 rounded-full backdrop-blur-sm border border-white/30 shadow-inner">
                        <BookOpen className="h-10 w-10 text-white" />
                     </div>
                     <h3 className="text-3xl font-serif font-bold mb-1">Schriftgeleerde</h3>
                     <p className="text-white/70 text-sm mb-6">Niveau 3 â€¢ 450 XP</p>
                     
                     <div className="relative pt-1">
                        <div className="flex mb-2 items-center justify-between text-xs text-white/80">
                            <span>Huidig</span>
                            <span>Volgend Niveau</span>
                        </div>
                        <div className="overflow-hidden h-2 mb-4 text-xs flex rounded bg-black/20">
                            <div style={{ width: "65%" }} className="shadow-none flex flex-col text-center whitespace-nowrap text-white justify-center bg-amber-400"></div>
                        </div>
                     </div>
                </CardContent>
             </Card>

             {/* Badges */}
             <Card className="border-slate-200">
                <CardHeader>
                     <CardTitle className="font-serif text-lg">Mijn Badges</CardTitle>
                </CardHeader>
                <CardContent>
                    <div className="grid grid-cols-3 gap-2">
                        {/* Earned Badge */}
                        <div className="flex flex-col items-center p-2 text-center">
                            <div className="h-12 w-12 rounded-full bg-amber-100 flex items-center justify-center mb-2 border border-amber-200">
                                <Calendar className="h-6 w-6 text-amber-600" />
                            </div>
                            <span className="text-xs font-medium text-slate-700">Dagenreeks</span>
                        </div>
                         
                         {/* Earned Badge */}
                        <div className="flex flex-col items-center p-2 text-center">
                            <div className="h-12 w-12 rounded-full bg-blue-100 flex items-center justify-center mb-2 border border-blue-200">
                                <Trophy className="h-6 w-6 text-blue-600" />
                            </div>
                            <span className="text-xs font-medium text-slate-700">Eerste 100%</span>
                        </div>

                         {/* Locked Badge */}
                         {!isPremium ? (
                            <div className="flex flex-col items-center p-2 text-center opacity-50 grayscale group relative cursor-pointer">
                                <div className="h-12 w-12 rounded-full bg-slate-100 flex items-center justify-center mb-2 border border-dashed border-slate-300">
                                    <Star className="h-6 w-6 text-slate-400" />
                                </div>
                                <span className="text-xs font-medium text-slate-500">Premium Held</span>
                                <div className="absolute top-0 right-0">
                                    <Lock className="h-3 w-3 text-slate-400" />
                                </div>
                            </div>
                         ) : (
                               <div className="flex flex-col items-center p-2 text-center">
                                    <div className="h-12 w-12 rounded-full bg-purple-100 flex items-center justify-center mb-2 border border-purple-200">
                                        <Star className="h-6 w-6 text-purple-600" />
                                    </div>
                                    <span className="text-xs font-medium text-slate-700">Premium Held</span>
                                </div>
                         )}

                         {/* More placeholders */}
                         <div className="flex flex-col items-center p-2 text-center opacity-40 grayscale">
                             <div className="h-12 w-12 rounded-full bg-slate-100 flex items-center justify-center mb-2">
                                <Zap className="h-6 w-6 text-slate-400" />
                             </div>
                             <span className="text-xs font-medium text-slate-500">Snelheid</span>
                         </div>
                    </div>
                </CardContent>
             </Card>
        </div>

      </div>
    </div>
  );
}

// Simple Badge component specifically for this page if needed, or use UI lib
function Badge({ variant, className, children }: { variant: string, className?: string, children: React.ReactNode }) {
    return <span className={`px-2 py-0.5 rounded text-xs font-semibold ${className}`}>{children}</span>
}
